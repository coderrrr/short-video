---
inclusion: always
---

# AWS 部署规范

## 部署区域

- **AWS Region**: 中国宁夏区域 (cn-northwest-1)
- **可用区**: 使用多个可用区实现高可用

## AWS 服务选择

### 计算服务
- **ECS (Elastic Container Service)**: 运行容器化的后端服务
- **Fargate**: 无服务器容器运行环境（推荐）
- **Lambda**: 处理异步任务（如AI处理、通知发送）

### 存储服务
- **S3**: 存储视频文件、封面图片、用户头像
  - 使用S3生命周期策略管理旧内容
  - 启用S3 Transfer Acceleration加速上传
- **EFS**: 共享文件系统（如需要）

### 数据库服务
- **RDS for MySQL**: 关系型数据库
  - 使用Multi-AZ部署实现高可用
  - 启用自动备份
  - 使用读副本分离读写负载
- **ElastiCache for Redis**: 缓存服务
  - 使用集群模式实现高可用

### 网络服务
- **VPC**: 虚拟私有云
- **ALB (Application Load Balancer)**: 应用负载均衡
- **CloudFront**: CDN加速（视频和静态资源分发）
- **Route 53**: DNS服务

### 安全服务
- **IAM**: 身份和访问管理
- **Secrets Manager**: 密钥管理（存储API密钥、数据库密码等）
- **WAF**: Web应用防火墙
- **Shield**: DDoS防护

### 监控和日志
- **CloudWatch**: 监控和日志
- **X-Ray**: 分布式追踪
- **CloudTrail**: API调用审计

### AI/ML服务
- **SageMaker**: 如需自建AI模型
- **Bedrock**: AWS托管的LLM服务（可选）
- **Rekognition**: 图像和视频分析（可用于内容审核）
- **Transcribe**: 语音转文字
- **Textract**: OCR文字提取

### 消息队列
- **SQS**: 简单队列服务（异步任务队列）
- **SNS**: 简单通知服务（推送通知）

## 架构部署图

```
Internet
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│                    CloudFront (CDN)                      │
│              (视频和静态资源分发)                          │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│                    Route 53 (DNS)                        │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│                    WAF + Shield                          │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│              Application Load Balancer                   │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│                         VPC                              │
│  ┌────────────────────────────────────────────────┐    │
│  │           Public Subnet (多AZ)                  │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐    │    │
│  │  │ NAT GW   │  │ NAT GW   │  │ Bastion  │    │    │
│  │  └──────────┘  └──────────┘  └──────────┘    │    │
│  └────────────────────────────────────────────────┘    │
│                                                          │
│  ┌────────────────────────────────────────────────┐    │
│  │          Private Subnet (多AZ)                  │    │
│  │  ┌──────────────────────────────────────┐     │    │
│  │  │    ECS Fargate (后端服务)             │     │    │
│  │  │  ┌────────┐  ┌────────┐  ┌────────┐ │     │    │
│  │  │  │API服务 │  │AI服务  │  │用户服务│ │     │    │
│  │  │  └────────┘  └────────┘  └────────┘ │     │    │
│  │  └──────────────────────────────────────┘     │    │
│  └────────────────────────────────────────────────┘    │
│                                                          │
│  ┌────────────────────────────────────────────────┐    │
│  │         Database Subnet (多AZ)                  │    │
│  │  ┌──────────┐  ┌──────────────┐               │    │
│  │  │RDS MySQL │  │ElastiCache   │               │    │
│  │  │(Multi-AZ)│  │Redis(Cluster)│               │    │
│  │  └──────────┘  └──────────────┘               │    │
│  └────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│                    S3 (视频存储)                         │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│              Lambda (异步任务处理)                        │
│  ┌────────┐  ┌────────┐  ┌────────┐                   │
│  │AI处理  │  │通知发送│  │数据统计│                   │
│  └────────┘  └────────┘  └────────┘                   │
└─────────────────────────────────────────────────────────┘
```

## 环境配置

### 开发环境 (dev)
- 单AZ部署
- 最小实例规格
- 开发数据库

### 测试环境 (staging)
- 单AZ部署
- 中等实例规格
- 测试数据库

### 生产环境 (prod)
- 多AZ部署
- 生产级实例规格
- 高可用配置
- 自动扩展

## 成本优化

- 使用Spot实例运行非关键任务
- 使用S3 Intelligent-Tiering自动优化存储成本
- 使用CloudFront减少S3请求成本
- 使用Reserved Instances降低RDS成本
- 设置CloudWatch告警监控成本

## 安全最佳实践

- 所有服务部署在VPC内
- 使用Security Groups限制网络访问
- 启用VPC Flow Logs
- 使用Secrets Manager管理敏感信息
- 启用S3 bucket加密
- 启用RDS加密
- 定期进行安全审计

## 备份和灾难恢复

- RDS自动备份（保留7-35天）
- S3启用版本控制
- 定期进行灾难恢复演练
- 跨区域复制关键数据（可选）

## CI/CD

- 使用CodePipeline + CodeBuild + CodeDeploy
- 或使用GitHub Actions + AWS CLI
- 容器镜像存储在ECR (Elastic Container Registry)
- 使用蓝绿部署或滚动部署策略

## 监控和告警

- CloudWatch监控所有AWS资源
- 设置关键指标告警：
  - CPU使用率 > 80%
  - 内存使用率 > 80%
  - 磁盘使用率 > 80%
  - API错误率 > 5%
  - 响应时间 > 2s
- 使用CloudWatch Logs Insights分析日志
- 集成SNS发送告警通知

## 合规性

- 遵守AWS中国区域的合规要求
- 数据存储在中国境内
- 符合网络安全法和数据安全法
